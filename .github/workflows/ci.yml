name: CI - Build and Test Services

on:
  push:
    branches: ["**"]
  pull_request:
    branches: [main]

jobs:
  quality-gates:
    name: Lint + Schema + Unit Tests
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: .
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install quality dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest flake8 pandas pendulum faker minio

      - name: Lint Python code
        run: |
          flake8 src airflow/dags test --max-line-length=120 --ignore=E501,W503

      - name: Validate SQL schema
        run: |
          pytest -q test/test_sql_schema.py

      - name: Run unit tests
        run: |
          pytest -q test --ignore=test/test_sql_schema.py

  build-and-test-services:
    name: Build and Test Docker Services
    runs-on: ubuntu-latest
    needs: quality-gates
    steps:
      - uses: actions/checkout@v4

      - name: Create CI .env
        run: |
          cat > .env << 'EOF'
          POSTGRES_HOST=postgres
          POSTGRES_PORT=5432
          POSTGRES_USER=healthcare_admin
          POSTGRES_PASSWORD=healthcare_secret
          POSTGRES_DB=healthcare_analytics
          AIRFLOW_DB=airflow
          MINIO_ROOT_USER=minioadmin
          MINIO_ROOT_PASSWORD=minioadmin123
          MINIO_ENDPOINT=minio:9000
          MINIO_ACCESS_KEY=minioadmin
          MINIO_SECRET_KEY=minioadmin123
          MINIO_BUCKET_BRONZE=healthcare-bronze
          MINIO_BUCKET_SILVER=healthcare-silver
          MINIO_BUCKET_QUARANTINE=healthcare-quarantine
          MINIO_BUCKET_REPORTS=healthcare-reports
          MB_DB_TYPE=postgres
          MB_DB_DBNAME=metabase
          MB_DB_PORT=5432
          MB_DB_USER=healthcare_admin
          MB_DB_PASS=healthcare_secret
          MB_DB_HOST=postgres
          _AIRFLOW_WWW_USER_USERNAME=admin
          _AIRFLOW_WWW_USER_PASSWORD=admin
          AIRFLOW_UID=50000
          AIRFLOW_GID=0
          NUM_PATIENTS=200
          NUM_VISITS=600
          NUM_ADMISSIONS=120
          NUM_TREATMENTS=1000
          EOF

      - name: Validate compose config
        run: docker compose --env-file .env config --quiet

      - name: Build Airflow images
        run: |
          docker compose build --parallel airflow-init airflow-webserver airflow-scheduler

      - name: Pull third-party service images
        run: |
          docker compose pull postgres minio minio-init metabase

      - name: Start services
        run: |
          docker compose up -d postgres minio minio-init airflow-init airflow-webserver airflow-scheduler metabase

      - name: Test service health
        run: |
          set -e

          echo "Checking PostgreSQL..."
          for i in $(seq 1 30); do
            if docker compose exec -T postgres pg_isready -U healthcare_admin -d healthcare_analytics >/dev/null 2>&1; then
              echo "PostgreSQL healthy"
              break
            fi
            [ "$i" -eq 30 ] && { echo "PostgreSQL failed health check"; exit 1; }
            sleep 5
          done

          echo "Checking MinIO..."
          for i in $(seq 1 30); do
            if curl -fsS http://localhost:9000/minio/health/live >/dev/null; then
              echo "MinIO healthy"
              break
            fi
            [ "$i" -eq 30 ] && { echo "MinIO failed health check"; exit 1; }
            sleep 5
          done

          echo "Checking Airflow webserver..."
          for i in $(seq 1 36); do
            if curl -fsS http://localhost:8080/health >/dev/null; then
              echo "Airflow webserver healthy"
              break
            fi
            [ "$i" -eq 36 ] && { echo "Airflow webserver failed health check"; exit 1; }
            sleep 5
          done

          echo "Checking Airflow scheduler image execution..."
          docker compose exec -T airflow-scheduler airflow version >/dev/null
          echo "Airflow scheduler command succeeded"

          echo "Checking Metabase..."
          for i in $(seq 1 40); do
            status=$(curl -fsS http://localhost:3000/api/health | python3 -c "import sys,json; print(json.load(sys.stdin).get('status',''))" || true)
            if [ "$status" = "ok" ]; then
              echo "Metabase healthy"
              break
            fi
            [ "$i" -eq 40 ] && { echo "Metabase failed health check"; exit 1; }
            sleep 5
          done

      - name: Dump container status
        if: always()
        run: docker compose ps

      - name: Dump logs on failure
        if: failure()
        run: docker compose logs --tail=80

      - name: Tear down
        if: always()
        run: docker compose down -v
