name: CI — Lint, Validate & Build

on:
  push:
    branches: ["**"]
  pull_request:
    branches: [main]

jobs:

  lint:
    name: Lint Python
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install linters
        run: pip install flake8 pyflakes

      - name: Lint DAGs
        run: flake8 airflow/dags/ --max-line-length=120 --ignore=E501,W503

      - name: Lint src/
        run: flake8 src/ --max-line-length=120 --ignore=E501,W503

  # Validate docker-compose
  validate-compose:
    name: Validate docker-compose.yml
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare compose env file
        run: |
          cp .env.example .env
          cat >> .env << 'EOF'
          NUM_PATIENTS=100
          NUM_VISITS=300
          NUM_ADMISSIONS=60
          NUM_TREATMENTS=500
          AIRFLOW_UID=50000
          AIRFLOW_GID=0
          MINIO_BUCKET_BRONZE=healthcare-bronze
          MINIO_BUCKET_SILVER=healthcare-silver
          MINIO_BUCKET_QUARANTINE=healthcare-quarantine
          MINIO_BUCKET_REPORTS=healthcare-reports
          EOF

      - name: Check compose file is valid
        run: docker compose --env-file .env config --quiet

  # Build custom Docker images
  build-images:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [lint, validate-compose]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build project Airflow image
        uses: docker/build-push-action@v5
        with:
          context: .
          dockerfile: ./Dockerfile
          push: false
          tags: healthcare-platform/airflow:ci
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Validate DAG imports
  validate-dags:
    name: Validate Airflow DAG imports
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install minimal deps for import test
        run: |
          pip install apache-airflow==2.9.1 \
            --constraint "https://raw.githubusercontent.com/apache/airflow/constraints-2.9.1/constraints-3.11.txt"

      - name: Test all DAGs import without errors
        run: |
          python - << 'EOF'
          import sys, importlib.util, pathlib
          dag_files = list(pathlib.Path("airflow/dags").glob("*.py"))
          errors = []
          for f in dag_files:
              spec = importlib.util.spec_from_file_location(f.stem, f)
              mod  = importlib.util.module_from_spec(spec)
              try:
                  spec.loader.exec_module(mod)
                  print(f"  ✓  {f.name}")
              except Exception as e:
                  errors.append(f"{f.name}: {e}")
                  print(f"  ✗  {f.name}: {e}")
          if errors:
              sys.exit(1)
          print(f"\nAll {len(dag_files)} DAG(s) imported successfully.")
          EOF
