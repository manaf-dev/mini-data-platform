name: Data Flow Validation

on:
  workflow_run:
    workflows: ["CD â€” Deploy & Health Check"]
    types: [completed]
  workflow_dispatch:

jobs:
  validate-flow:
    name: Validate MinIO -> Airflow -> PostgreSQL -> Metabase
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    steps:
      - uses: actions/checkout@v4

      - name: Create validation .env
        run: |
          cat > .env << 'EOF'
          POSTGRES_HOST=postgres
          POSTGRES_PORT=5432
          POSTGRES_USER=healthcare_admin
          POSTGRES_PASSWORD=healthcare_secret
          POSTGRES_DB=healthcare_analytics
          AIRFLOW_DB=airflow
          MINIO_ROOT_USER=minioadmin
          MINIO_ROOT_PASSWORD=minioadmin123
          MINIO_ENDPOINT=minio:9000
          MINIO_ACCESS_KEY=minioadmin
          MINIO_SECRET_KEY=minioadmin123
          MINIO_BUCKET_BRONZE=healthcare-bronze
          MINIO_BUCKET_SILVER=healthcare-silver
          MINIO_BUCKET_QUARANTINE=healthcare-quarantine
          MINIO_BUCKET_REPORTS=healthcare-reports
          MB_DB_TYPE=postgres
          MB_DB_DBNAME=metabase
          MB_DB_PORT=5432
          MB_DB_USER=healthcare_admin
          MB_DB_PASS=healthcare_secret
          MB_DB_HOST=postgres
          MB_ADMIN_EMAIL=admin@healthcare.local
          MB_ADMIN_PASSWORD=admin1234!
          _AIRFLOW_WWW_USER_USERNAME=admin
          _AIRFLOW_WWW_USER_PASSWORD=admin
          AIRFLOW_UID=50000
          AIRFLOW_GID=0
          NUM_PATIENTS=200
          NUM_VISITS=600
          NUM_ADMISSIONS=120
          NUM_TREATMENTS=1000
          EOF

      - name: Prepare data permissions
        run: |
          mkdir -p data/raw
          sudo chown -R 50000:0 data/
          sudo chmod -R 775 data/

      - name: Start platform
        run: |
          docker compose up -d --build

      - name: Wait for platform health
        run: |
          set -e

          for i in $(seq 1 30); do
            if docker compose exec -T postgres pg_isready -U healthcare_admin -d healthcare_analytics >/dev/null 2>&1; then
              break
            fi
            [ "$i" -eq 30 ] && { echo "Postgres not ready"; exit 1; }
            sleep 5
          done

          for i in $(seq 1 30); do
            if curl -fsS http://localhost:9000/minio/health/live >/dev/null; then
              break
            fi
            [ "$i" -eq 30 ] && { echo "MinIO not ready"; exit 1; }
            sleep 5
          done

          for i in $(seq 1 36); do
            if curl -fsS http://localhost:8080/health >/dev/null; then
              break
            fi
            [ "$i" -eq 36 ] && { echo "Airflow webserver not ready"; exit 1; }
            sleep 5
          done

          for i in $(seq 1 40); do
            status=$(curl -fsS http://localhost:3000/api/health | python3 -c "import sys,json; print(json.load(sys.stdin).get('status',''))" || true)
            if [ "$status" = "ok" ]; then
              break
            fi
            [ "$i" -eq 40 ] && { echo "Metabase not ready"; exit 1; }
            sleep 5
          done

      - name: Apply warehouse DDL
        run: |
          docker compose exec -T postgres \
            psql -U healthcare_admin -d healthcare_analytics -v ON_ERROR_STOP=1 \
            < sql/ddl.sql

      - name: Run master pipeline DAG
        run: |
          RUN_DATE=$(date -u +%F)
          echo "RUN_DATE=$RUN_DATE" >> "$GITHUB_ENV"
          docker compose exec -T airflow-scheduler \
            airflow dags test healthcare_master_pipeline "$RUN_DATE"

      - name: Validate MinIO bronze and silver outputs
        run: |
          set -e

          YEAR=$(date -u -d "$RUN_DATE" +%Y)
          MONTH=$(date -u -d "$RUN_DATE" +%m)
          DAY=$(date -u -d "$RUN_DATE" +%d)

          docker compose exec -T minio \
            mc alias set local http://localhost:9000 minioadmin minioadmin123

          for layer in bronze silver; do
            for dataset in patients visits admissions treatments billing; do
              COUNT=$(docker compose exec -T minio sh -c \
                "mc ls --recursive local/healthcare-${layer}/${dataset}/${YEAR}/${MONTH}/${DAY}/ 2>/dev/null | wc -l")
              if [ "${COUNT:-0}" -gt 0 ]; then
                echo "${layer}/${dataset}: ${COUNT} file(s)"
              else
                echo "Missing data in ${layer}/${dataset}/${YEAR}/${MONTH}/${DAY}"
                exit 1
              fi
            done
          done

      - name: Validate PostgreSQL row counts
        run: |
          python3 - << 'PYEOF'
          import subprocess
          import sys

          tables = {
              "patients": 50,
              "visits": 50,
              "admissions": 5,
              "treatments": 50,
              "billing": 25,
              "mart_daily_kpis": 1,
              "mart_department_stats": 1,
              "mart_patient_stats": 25,
          }

          for table, minimum in tables.items():
              r = subprocess.run(
                  [
                      "docker", "compose", "exec", "-T", "postgres",
                      "psql", "-U", "healthcare_admin", "-d", "healthcare_analytics",
                      "-t", "-c", f"SELECT COUNT(*) FROM {table};",
                  ],
                  capture_output=True,
                  text=True,
                  check=False,
              )
              if r.returncode != 0:
                  print(f"Query failed for {table}: {r.stderr}")
                  sys.exit(1)
              count = int(r.stdout.strip() or 0)
              if count < minimum:
                  print(f"{table}: {count} rows (expected >= {minimum})")
                  sys.exit(1)
              print(f"{table}: {count} rows")
          PYEOF

      - name: Validate Metabase API health
        run: |
          STATUS=$(curl -s http://localhost:3000/api/health \
            | python3 -c "import sys,json; print(json.load(sys.stdin).get('status',''))")
          if [ "$STATUS" != "ok" ]; then
            echo "Metabase returned status: $STATUS"
            exit 1
          fi
          echo "Metabase healthy"

      - name: Dump logs on failure
        if: failure()
        run: docker compose logs --tail=120

      - name: Tear down
        if: always()
        run: docker compose down -v
