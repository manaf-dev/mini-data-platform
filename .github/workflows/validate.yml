name: Data Flow Validation

on:
  workflow_run:
    workflows: ["CD — Deploy & Health Check"]
    types: [completed]
  workflow_dispatch:

jobs:
  validate:
    name: Validate End-to-End Data Flow
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'

    steps:
      - uses: actions/checkout@v4

      - name: Create .env
        run: |
          cat > .env << 'EOF'
          POSTGRES_HOST=postgres
          POSTGRES_PORT=5432
          POSTGRES_USER=healthcare_admin
          POSTGRES_PASSWORD=healthcare_secret
          POSTGRES_DB=healthcare_analytics
          AIRFLOW_DB=airflow
          MINIO_ROOT_USER=minioadmin
          MINIO_ROOT_PASSWORD=minioadmin123
          MINIO_ENDPOINT=minio:9000
          MINIO_ACCESS_KEY=minioadmin
          MINIO_SECRET_KEY=minioadmin123
          MINIO_BUCKET_BRONZE=healthcare-bronze
          MINIO_BUCKET_SILVER=healthcare-silver
          MINIO_BUCKET_QUARANTINE=healthcare-quarantine
          MINIO_BUCKET_REPORTS=healthcare-reports
          MB_DB_TYPE=postgres
          MB_DB_DBNAME=metabase
          MB_DB_PORT=5432
          MB_DB_USER=healthcare_admin
          MB_DB_PASS=healthcare_secret
          MB_DB_HOST=postgres
          MB_ADMIN_EMAIL=admin@healthcare.local
          MB_ADMIN_PASSWORD=admin1234!
          _AIRFLOW_WWW_USER_USERNAME=admin
          _AIRFLOW_WWW_USER_PASSWORD=admin
          AIRFLOW_UID=50000
          AIRFLOW_GID=0
          NUM_PATIENTS=1000
          NUM_VISITS=3000
          NUM_ADMISSIONS=600
          NUM_TREATMENTS=5000
          EOF
          sed -i 's/^[[:space:]]*//' .env
          echo "--- .env sanity check (first 3 lines) ---"
          head -3 .env


      - name: Create data directory with correct permissions
        run: |
          mkdir -p data/raw
          sudo chown -R 50000:0 data/
          sudo chmod -R 775 data/

      - name: Start platform
        run: |
          docker compose up -d --build
          echo "Waiting 120s for services to initialise..."
          sleep 120

      - name: Apply warehouse DDL
        run: |
          docker compose exec -T postgres \
            psql -U healthcare_admin -d healthcare_analytics \
            -v ON_ERROR_STOP=1 < sql/ddl.sql
          echo "✓ DDL applied"

      - name: Unpause bronze DAG
        run: |
          docker compose exec -T airflow-scheduler \
            airflow dags unpause healthcare_bronze_ingestion_v1
          echo "✓ Bronze DAG unpaused"

      - name: Trigger bronze ingestion DAG
        run: |
          docker compose exec -T airflow-scheduler \
            airflow dags trigger healthcare_bronze_ingestion_v1
          echo "✓ Bronze DAG triggered"

      
      - name: Validate MinIO — bronze files exist
        run: |
          for attempt in $(seq 1 40); do
            all_found=1
            for dataset in patients visits admissions treatments billing; do
              COUNT=$(docker compose exec -T minio sh -c \
                "mc alias set local http://localhost:9000 minioadmin minioadmin123 --quiet >/dev/null 2>&1 \
                 && mc ls --recursive local/healthcare-bronze/${dataset}/ 2>/dev/null | wc -l")
              if [ "${COUNT:-0}" -gt 0 ]; then
                echo "  ✓ bronze/${dataset}: ${COUNT} file(s)"
              else
                echo "  … bronze/${dataset}: pending"
                all_found=0
              fi
            done

            [ "$all_found" -eq 1 ] && { echo "✓ All bronze files present"; break; }
            [ "$attempt" -eq 40 ] && {
              echo "✗ Bronze files not ready after 10 minutes"
              docker compose logs --tail=40 airflow-scheduler
              exit 1
            }
            echo "Attempt ${attempt}/40 — retrying in 15s..."
            sleep 15
          done

      # Trigger silver DAG
      - name: Trigger silver pipeline DAG
        run: |
          docker compose exec -T airflow-scheduler \
            airflow dags trigger healthcare_silver_pipeline_v1
          echo "✓ Silver DAG triggered"

     
      - name: Validate MinIO — silver files exist
        run: |
          for attempt in $(seq 1 40); do
            all_found=1
            for dataset in patients visits admissions treatments billing; do
              COUNT=$(docker compose exec -T minio sh -c \
                "mc alias set local http://localhost:9000 minioadmin minioadmin123 --quiet >/dev/null 2>&1 \
                 && mc ls --recursive local/healthcare-silver/${dataset}/ 2>/dev/null | wc -l")
              if [ "${COUNT:-0}" -gt 0 ]; then
                echo "  ✓ silver/${dataset}: ${COUNT} file(s)"
              else
                echo "  … silver/${dataset}: pending"
                all_found=0
              fi
            done

            [ "$all_found" -eq 1 ] && { echo "✓ All silver files present"; break; }
            [ "$attempt" -eq 40 ] && {
              echo "✗ Silver files not ready after 10 minutes"
              docker compose logs --tail=60 airflow-scheduler
              exit 1
            }
            echo "Attempt ${attempt}/40 — retrying in 15s..."
            sleep 15
          done

      # Trigger gold DAG
      - name: Trigger gold pipeline DAG
        run: |
          docker compose exec -T airflow-scheduler \
            airflow dags trigger healthcare_gold_pipeline_v1
          echo "✓ Gold DAG triggered"

      - name: Validate PostgreSQL — all tables populated
        run: |
          python3 - << 'PYEOF'
          import subprocess, sys, time

          tables = {
              "patients":              100,
              "visits":                100,
              "admissions":              5,
              "treatments":            100,
              "billing":                50,
              "mart_daily_kpis":         1,
              "mart_department_stats":   1,
              "mart_patient_stats":     50,
          }

          def row_count(table):
              r = subprocess.run(
                  ["docker", "compose", "exec", "-T", "postgres",
                   "psql", "-U", "healthcare_admin", "-d", "healthcare_analytics",
                   "-t", "-c", f"SELECT COUNT(*) FROM {table};"],
                  capture_output=True, text=True
              )
              try:
                  return int(r.stdout.strip())
              except ValueError:
                  return 0

          for attempt in range(1, 41):
              counts = {t: row_count(t) for t in tables}
              if all(counts[t] >= tables[t] for t in tables):
                  for t, c in counts.items():
                      print(f"  ✓ {t:<28} {c:>8,} rows")
                  print("\n✓ All tables populated")
                  sys.exit(0)

              if attempt == 40:
                  print("✗ Tables not ready after 10 minutes:")
                  for t, c in counts.items():
                      mark = "✓" if c >= tables[t] else "✗"
                      print(f"  {mark} {t:<28} {c:>8,} rows  (need ≥{tables[t]})")
                  sys.exit(1)

              print(f"Attempt {attempt}/40 — waiting 15s...")
              time.sleep(15)
          PYEOF

      # Data quality checks — silver validation must have stripped all
      # bad rows so the gold layer should have zero negative amounts / bad dates.
      - name: Validate data quality — no bad rows in gold layer
        run: |
          docker compose exec -T postgres \
            psql -U healthcare_admin -d healthcare_analytics -t -c \
            "SELECT COUNT(*) FROM billing WHERE total_amount < 0;" \
          | python3 -c "
          import sys
          count = int(input().strip())
          if count > 0:
              print(f'✗ {count} billing rows with negative total_amount')
              sys.exit(1)
          print('✓ No negative billing amounts')
          "

          docker compose exec -T postgres \
            psql -U healthcare_admin -d healthcare_analytics -t -c \
            "SELECT COUNT(*) FROM visits WHERE visit_end_ts < visit_start_ts;" \
          | python3 -c "
          import sys
          count = int(input().strip())
          if count > 0:
              print(f'✗ {count} visits with end before start')
              sys.exit(1)
          print('✓ No visits with end_ts before start_ts')
          "

          docker compose exec -T postgres \
            psql -U healthcare_admin -d healthcare_analytics -t -c \
            "SELECT COUNT(*) FROM admissions WHERE discharge_ts < admit_ts;" \
          | python3 -c "
          import sys
          count = int(input().strip())
          if count > 0:
              print(f'✗ {count} admissions with discharge before admit')
              sys.exit(1)
          print('✓ No admissions with discharge before admit')
          "

      # Metabase health
      - name: Validate Metabase API health
        run: |
          STATUS=$(curl -s http://localhost:3000/api/health \
            | python3 -c "import sys,json; print(json.load(sys.stdin).get('status',''))")
          if [ "$STATUS" = "ok" ]; then
            echo "✓ Metabase API healthy"
          else
            echo "✗ Metabase returned status: $STATUS"
            exit 1
          fi

      - name: Print validation summary
        run: |
          echo "  DATA FLOW VALIDATION — PASSED"
          
      - name: Dump logs on failure
        if: failure()
        run: |
          echo "=== airflow-scheduler (last 100 lines) ==="
          docker compose logs --tail=100 airflow-scheduler
          echo "=== airflow-init ==="
          docker compose logs --tail=30 airflow-init
          echo "=== postgres ==="
          docker compose logs --tail=20 postgres

      - name: Tear down
        if: always()
        run: docker compose down -v